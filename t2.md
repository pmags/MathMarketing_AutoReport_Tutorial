# How to dynamically generate Corporate Reports from Notebooks - Part II
*Introduction to LaTeX: using packages and adding a cover and back cover*

On the first part of this series we have already layout the project structure. Now we will look into greater detail on to some of its elements.

In this parte we will be covering the following topics:
- A brief summary about Rmarkdown headers and how to manipulate output with yaml commands,
- An overview of LaTeX and its different elements included with the output,
- Difference between a LaTeX template and style,
- How to import a pdf file to be used as cover page,
- How to build a simple LaTeX file to be used as back cover

We are using RMarkdown <link> for data analysis and will export our conclusions into a formated PDF report. **It is our goal is to free the analyst from the burden of document formating**. Therefore, the Notebook should contain as minimum formating elements as possible.

**Once again, this tutorial illustrates a potential approached and is by no means exautive. For the purpose of conveting an idea ot technic some overengineering might be included.**

## How rendering works

![alt](images/rmarkdownflow.png)

We can render a R Markdowon document using render() function on a R console or directly from RStudio using the knitr icon.

![imagem rstudio knitr]

During render, R Markdown will feed the .Rmd file into knitr in order to run code blocks and output a Markdown file. This document is subsquently processed by pandoc which is responsible for creating the finish format. Using pandoc, Rmarkdown can be converted to a variety of outputs including word documents, HTML pages or power point presentations.

We mentioned earlier on the first part that an alternative approach would be to generate a HTML which would generate a PDF report. A possible implementantion would be to generate a HTML from a Markdown document using pandoc, and subsquently use pandoc again to convert from HTML into PDF.

To follow this tutorial the user needs to make sure that `knitr` and `pandoc` packages are installed. They do not need to worry when using RStudio because both packages come preinstalled with this IDE.

## What is Latex

LaTeX is a document preparation system which is often used for making books or highly technical mathematical articles. LaTeX is well-suited for expressing mathematical formulas on electronic devices in a more human readable format by allowing them to be shown in a format similar to how they would be written in many textbooks or by hand and therefore is widely used on academic world. 

LaTeX is a typesetting system <link https://en.wikipedia.org/wiki/Typesetting>, it uses source code to generate a document in contrast to word editors like Microsoft Word where what you see is what you get. Despite the steep learning curve, it adds brings greater control over the convertion which guarantees consistency and allows very complex outputs.  

To able to export into pdf pandoc requires LaTeX to be installed. Because of its convinience and integration with Rmarkdown we advice the instalation of **tinitex** using the following code from inside a R session:

```r
install.packages("tinytex")
tinytex::install_tinytex()  # install TinyTeX
```
> TinyTeX is a lightweight, portable, cross-platform, and easy-to-maintain LaTeX distribution. The R companion package tinytex (Xie 2019e) can help you automatically install missing LaTeX packages when compiling LaTeX or R Markdown documents to PDF, and also ensures a LaTeX document is compiled for the correct number of times to resolve all cross-references. If you do not understand what these two things mean, you should probably follow our recommendation to install TinyTeX, because these details are often not worth your time or attention. [Rmarkdown: The definitive Guide]

## Setting up the R Notebook / R Markdown document for the first time 

R Markdown provides a platform for data science and general analytics which allows to both save and execute code and generate reports on a variety of formats that can be shared with an audience. R Markdown documents are fully reproducible and support dozens of static and dynamic output formats. 

When we create our first file with R studio we are greated with some placeholder code intended to work as an example of the different features present on R Markdown files. It is behind the scope of this tutorial to go through the different funcionalities and file structure possible with R Markdown. A curious reader can learn more from R studio introduction <https://rmarkdown.rstudio.com/lesson-1.html> and go into greater detail by studying this book <link>.

We are solely focused on the file output and that is defined by the YAML <link wikipedia> code chunck included at the beggining and which may look like this


```yaml
## yaml header with output definitions
---
title: "QiDigital_FitnessMarket"
author: "Math Marketing"
date : "March2020"
output: html_document
---
```
When `rmarkdown::render()` is used to generate the output, R will use this header as configuration commands and define the output. Right now, our file is rendered into an html document which is the standard output for markdown.

In order to run code the present configuration require that either the document be rendered or the output to show on a R console. One of the main attractions of a Notebook style framework like Jupyter is its hability to merge text and code blocks which can be ran and their results displayed from inside the document. For that we will transform our output from **html_document** into **html_notebook**.

An R Notebook is an R Markdown document with chunks that can be executed independently and interactively, with output visible immediately beneath the input. 

Additionally we will add information regarding pdf output. Our new YAML configuration header will look like this:

```yaml
title: "QiDigital_FitnessMarket"
author: "Math Marketing"
date : "March2020"
output: 
  pdf_document:
    latex_engine: xelatex
  html_notebook:
    df_print: paged
```
The user can have multiple output formats simultaneously allowing for a greater degree of flexibility. When rendered, if no option is chosen then it will use the first option that is included on YAML metadata. By default, if no output information is included, Rmarkdown renders to HTML.

The header as it is will run our file as a notebook and export to a pdf document when rendered using the default LaTeX template. For an article or quick pdf report this may suffice, but we want to extensively change our output which requires an additional layer of costumization.

Rmarkdown allows arguments to be passed into LaTeX and them into pdf directly through YAML header to access pandoc arguments. The following example installs a LaTeX package called *pdfpages* which allows us to import pfd files into our output.

```yaml
---
title: "QiDigital_FitnessMarket"
header_includes:
  - \usepackage{pdfpages} 
output: 
  pdf_document
---
```
Notice the line `latex_engine: xelatex`. RStudio supports by default both XeLaTeX and pdfTex engines for LaTeX. The reader does not have to worry about this argument and in most cases there is no need to change default configurations on RStudio. It is enought to know that we are using XeLaTeX because of utf8 and better use of installed fonts.

We will do more advance costumization and therefore we will include additional LaTeX directives and content and customize the Pandoc template. The `includes` option allow us to include content in document's header, before and/or after body.

- *in_header*: allows the inclusion of document or instructions which will run when the document is rendered. It is common to use this option to include a preamble similar to the one on our document. We will give it a different use though. Given the global impact of this option we will use it to include a custom style file with global options, packages and functions.

- *before_body*: in our project, body is the notebook where all our analysis are been made. This option allows us to introduce commands or documents just before our notebook begins to render. We will use this option to introduce our preamble.

- *after_body*: on a similar fashion to before body, after body option allows us to pass commands or include documents prior to our body. We will use this option to include our cover page.

Our YAML header would look something similar to the following:

```yaml
---
title: "QiDigital_FitnessMarket"
## Defines output
output:
  pdf_document:
    includes:
      after_body: latex/after_body.tex
      before_body: latex/before_body.tex
      in_header: latex/MathStyle.sty
    latex_engine: xelatex
    template: latex/MathTemplate.tex
  html_notebook:
    df_print: paged
## Output options to be used for pdf
footer-image: images/footer.png
geometry: margin=2.5cm
pdf-cover-image: images/mathCover.pdf
report-subtitle: Portuguese Fitness Industry
report-title: How fit is your marketing?
subparagraph: yes
documentclass: article
---
```

The remaining elements included on the header are varibles which are defined on our style or template file and will be explained when needed.

## Adding the cover page

Businesses value their branding and require that all communication comply to strict guidelines. Therefore, it is normal for some form of template to be already in place in your company. It is possible to design complex patterns with LaTeX, but is both combursome and time consuming. On most cases scnarios it makes more sense to import a pre-built cover into our document. Because we want our analyst to be able to change the report title according to the subject, we will add an extra layer of costumization. For that we will have to introduce LaTeX packages into our report.

### LaTeX packages

Base LaTeX offers a variety of functions to generate documents, packages allow us to expand on those funcionalities. A package is a file or collection of files containing extra LaTeX commands and programming which add new styling features or modify those already existing. There are two main file types: class files with .cls extension, and style files with .sty extension. There may be ancillary files as well. When you try to typeset a document which requires a package which is not installed on your system, LaTeX will warn you with an error message that it is missing. You can download updates to packages you already have (both the ones that were installed along with your version of LaTeX as well as ones you added). There is no limit to the number of packages you can have installed on your computer, but there is a configurable limit to the number that can be used inside any one LaTeX document at the same time, although it depends on how big each package is. In practice there is no problem in having even a couple of dozen packages active. The main place to look for style packages on the Internet is CTAN. 

If you are using TinyTeX as your LaTeX distribution, we recommend that you run `inytex::tlmgr_install("pdfcrop")` to install the LaTeX package pdfcrop. If using tinytext as suggested before it will detect missing packages and install them

### Importing the cover

We need to expand base LaTeX funcionality with `pdfpages` <link> package in order to import pdf files. A file can be imported into a latex document as follows:

```latex
\documenclass{article}

% imports package
\usepackage{pdfpages}

\begin{document}
% imports a pdf found on path
\includespdf{file_path.pdf}
```
Because we are using Pandoc to render our document we aren't interacting directly to a LaTeX file. We need to add the option of a cover page to LaTeX template to be used when needed. The following code should be added to both to style and template. For covenience we created a new template which only differs from the original template by the inclusion of the following code.

```latex
% the following code should be included on your style document:
\usepackage{pdfpages}
\usepackage{tikz}
\usepackage{graphicx}

% on the template just before the \title page the following code should be included
begin{document}
$if(pdf-cover-image)$
$if(report-title)$
\NoBgThispage %does not apply background
\includepdf[pagecommand={\begin{tikzpicture}[remember picture, overlay] 
                            \node [scale=6, text width=3cm] at (8.2,-4) {\textbf{$report-title$}};
                            \node [scale=3, text width=4cm] at (5.2,-7.5) {\itshape{$report-subtitle$}};
                         \end{tikzpicture}}]{$pdf-cover-image$}
$endif$
$endif$
```
With this code in place we can now add the options *pdf-cover-image: pdf.path*, *report-title* and *report-subtitle* into Notebooks header. The title and subtitle are included as an overlay over the imported pdf. In here we have hard coded the poistion, but there is no need for it. The user can substitue it with a variable accessible from the header too.

## The back cover

As we saw before we can introduce aditional content following our analysis using the header option includes/after_body. We will use this option to include a simple back cover where we provide some adtional small printing like lincensing and copywrite. 

We could have follow a similar approach as before and just import a preformated PDF page. Instead we choose to type a simple .tex file. 

```latex
% adds a new page to the document
\newpage

% fills blank space and desables all style formats used on the document
~\vfill
\thispagestyle{empty}
\NoBgThispage

% adds text with color according to style guidelines

\noindent \textcolor{DarkPurple}{Copyright \copyright\ Math Marketing. All rights reserved \\} % Copyright notice

\noindent \textcolor{DarkPurple}{Images \copyright\ images used from Freepik.Technology vector created by upklyak - www.freepik.com \\}

\noindent \textcolor{DarkPurple}{\textsc{Published by Math Marketing}\\} % Publisher

\noindent \textcolor{DarkPurple}{\textsc{www.math.marketing}\\} % URL

\noindent \textcolor{DarkPurple}{Math Marketing has helped companies from a variety of industries to implement Data Driven processes. By mixing statistical proficiency, business knowledge and advance tools we help our customer answer though questions. Some of the largest brands share with us with their data challenges, and trust our data generated insights on everyday operational and strategic decisions.\\} % License information

\noindent \textcolor{DarkPurple}{Math Marketing has exercised reasonable care in the collecting, processing and reportting of this information but has not independently verified, validated ou audited the data to verify the accuracy or completeness of the information. Math Marketing gives no express or implied warranties, including but not limited to any warranties of merchantability or fitness for a particular purpose or use and shall not be How rendering worksliable to any entity or person using this document, or have nay liability with respect to this document. This report is for general purposes only, and is not a substitue for consultation with professional advisors.\\} % Warranties

\noindent \textcolor{DarkPurple}{\textit{March 2020}} % Printing/edition date
```
The initial `\newpage` command creates a page break allowing us to start on a separte page of our report. In subsquent sections of ths tutorial we will define a graphical style for our report which we don't wish to use here. We want our back cover to be as simple as possible and only contain colored text. The commands `\thispagestyle` and `\NoBgThispage` guarantee that no previous page formating spills over into this final page.

To start a paragraph without an indent, or to continue an interrupted paragraph, we use `\noindent`. The `\textcolor{DarkPurple}` changes the font color according to a custom pallete to be defined on subsquent sections. 

The above options require some aditional packages included on our style file but which we have not yet spoke about. They are going to be discussed deeper on later parts of this series. 

## Final thoughts and next steps

On this second part of our tutorial on how to generate dynamic corporate style reports from Data Science Notebooks we gave a highlevel view how R markdown outputs to PDF files and a brief introduction into LaTeX and packages. We then added both a cover and back cover to our report by importing PDF files.

For the reader looking to go into greater detail on any of this subjects we consider reading the following resources.

<link https://bookdown.org/yihui/rmarkdown/>
<link http://ctan.math.washington.edu/tex-archive/macros/latex/contrib/pdfpages/pdfpages.pdf>
<link https://pandoc.org/MANUAL.pdf>

--- 
Math Marketing <link> has helped companies from a variety of industries to implement Data Driven processes<link para texto de data driven marketing>. By mixing statistical proficiency, business knowledge and advance tools we help our customer answer though questions. Some of the largest brands share with us with their data challenges, and trust our data generated insights on everyday operational and strategic decisions.

If you want to learn about our projects and methodology reach us over the e-mail or contact any of our team managers directly on Linkedin<link>. We are always available to share our insights with you and listen to your experience.

