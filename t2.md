# How to dynamically generate Corporate Reports from Notebooks - Part II
*Creating a pdf template and style*

On the first part of this tutorial we layed out the projects basic struture and elements that we desire to include on the final output. On this second part we will go into greater detail on how some elements will be included on the final PDF report.

By the end of this second part our report will have:

- A cover including a title and subtitle which depends on the subject and can be changed inside the Notebook;
- A preamble where some concepts about the digital IQ are explan and that will be reused on similar reports (in some use cases it makes sense to include a small presentation or introduction); 
- Several graphical elements which are part of brand identify like footers or headers and can be changed directly from the notebook;
- Some custom elements which can be used when needed and are called using functions directly from inside the notebook.

Our target is reduce or remove output formating so that the Notebook user can focus solely on data analysis. To that end, we will need to include aditional elements to the Notebook setup with instructions regarding its subsquent output.

We will use Rmarkdow <link> as a Notebook and the final output will be a PDF report. Because we are using R the user needs to make sure that knitr and pandoc packages are installed. 

Markdown was originaly designed to be exported into HTML and has, since its release, evolved into acpeting other forms of convertion. In order to generate a pdf report we will be using pandoc <link> and LaTeX <link>, therefore we need to understand how this different elements interact together.

**Before we start we remind that this tutorila illustrates a potential approached and is by no means exautive. For the purpose of conveting an idea ot technic some overengineering might be included.**

The other parts of this tutorial can be access below:

Part I. Setting up the project <link>
Part II. Latex & pdf template and style <link>
Part III. R functions and themes <link>

## What is Latex

LaTeX is a document preparation system which is often used for making books or highly technical mathematical articles. LaTeX is well-suited for expressing mathematical formulas on electronic devices in a more human readable format by allowing them to be shown in a format similar to how they would be written in many textbooks or by hand and therefore is widely used on academic world. 

LaTeX is a typesetting system <link https://en.wikipedia.org/wiki/Typesetting>, it uses source code to generate a document in contrast to word editors like Microsoft Word where what you see is what you get. Despite the steep learning curve, it adds brings greater control over the convertion which guarantees consistency and allows very complex outputs.  

In case the user opts to use Rstudio the necessary packages knitr and pandoc will have been already installed and available and he can already convert notebooks into HTML or DOC files. In order to export as a PDF file, it is required that LaTeX be installed. We suggest following the instructions found on the book *"Rmarkdown: The definitive Guide"* <link https://bookdown.org/yihui/rmarkdown/installation.html> and install **tinitex** <link https://yihui.org/tinytex/> 


```r
install.packages("tinytex")
tinytex::install_tinytex()  # install TinyTeX
```
> TinyTeX is a lightweight, portable, cross-platform, and easy-to-maintain LaTeX distribution. The R companion package tinytex (Xie 2019e) can help you automatically install missing LaTeX packages when compiling LaTeX or R Markdown documents to PDF, and also ensures a LaTeX document is compiled for the correct number of times to resolve all cross-references. If you do not understand what these two things mean, you should probably follow our recommendation to install TinyTeX, because these details are often not worth your time or attention. [Rmarkdown: The definitive Guide]

## Notebook header

All information about the notebook output is included on his header which is written in YAML <link wikipedia>. When the user runs `rmarkdown::render()` (or uses the knitr button in RStudio) it will look into the configuration instructions included on the header. Lets breake down our Notebook header:

```yaml

---
title: "QiDigital_FitnessMarket"
output: 
  pdf_document:
    latex_engine: xelatex
    includes:
      in_header: latex/MathStyle.sty
      before_body: latex/before_body.tex
      after_body: latex/after_body.tex
    template: latex/MathTemplate.tex
geometry: margin=2.5cm
documentclass: article
subparagraph: yes
pdf-cover-image: "images/mathCover.pdf"
report-title: "How fit is your marketing?"
report-subtitle: "Portuguese Fitness Industry" 
footer-image: images/footer.png
---

```
The second argument of this function is the output format, which in our case is a pdf_document. The user can have multiple output formats simultaneously allowing for a greater degree of flexibility. When rendered, if no option is chosen then it will use the first option that is included on YAML metadata. By default, if no output information is included, Rmarkdown renders to HTML.

The user can pass aditional option which will change the pdf output (behare of the correct indentention). In our case we pass the following aditional options:

- *latex_engine*: on our case we will be generating using the XeLaTeX engine. The user can learn more about XeLateX here <https://www.overleaf.com/learn/latex/XeLaTeX>. LaTeX engines are behind the scope of this tutorial but suffice is to say that we will be using XeLaTeX in order to extend the available fonts 
- *includes: / in_header*: this elements allow us to introduce LaTeX which will be used through out the entire document. Because we plan to extensively manipulate our output we will use a Latex style document which gather all the major transformations. Alternatively we could have passed intructions directly into YAML metadata or into the notebook. The following code includes a LaTeX package:

```yaml
---
title: "QiDigital_FitnessMarket"
header_includes:
  - \usepackage{pdfpages} 
output: 
  pdf_document
---
```
What this codes does is to change the default template by adding a line. It is important for the reader to know about this option but it defeats our purpose of reducing the impact of formating to a minimum on the Notebook.

- *includes: / before_body*: this element allows the introduction of a LaTeX file before the main body of our report (which is the notebook). We will use this option to include our preamble
- *includes: / after_body*: similar to before body, it allows to introduce elements after the report main body. We will use this for the back cover.
- *template*: this element allows us to include a custom latex template. In our case we will use this elements to include small changes to the standard template.
 
Advanced LaTeX user may argue that for on our case it would be redundant to include both a new template and a LaTeX style file. In fact, some if not all the necessary transformations could have been using either files and therefore avoiding the need for two separate files. Because we are accessing LaTeX indirectly through the Rmarkdown package we opt to use the same template as shipped with the package in order to avoid any breakdown during rendering.

The remaining elements included on the header include LaTeX package option which will be discussed later.

## Dynamic cover page

Image consistency is very important and expected on corporate world. Chances are that some if not all graphical elements were previously design by a communication team. In that case there is no need to design the cover from the ground up, we just need to learn how to import it into our report and leave some elements flexible so that it can be changed later on.

To keep high fidely on the output we advice to import the cover as a pdf file. To do so we follow the following steps:

### 1. Add the pdf package to latex:
On the style file include the following line of code to activate the pdfpages LaTex package:

```latex
\usepackage{pdfpages}
```

### 2. Change the template in order to include a new cover page
On our repository we have included a copy of the tex template used by Rmarkdown under the hood. Just before the \titlepage we include the following code:

```latex
%% ----- Includes cover pdf page into file
\begin{document}
$if(pdf-cover-image)$
$if(report-title)$
\NoBgThispage %does not apply background
\includepdf[pagecommand={\begin{tikzpicture}[remember picture, overlay] 
                            \node [scale=6, text width=3cm] at (8.2,-4) {\textbf{$report-title$}};
                            \node [scale=3, text width=4cm] at (5.2,-7.5) {\itshape{$report-subtitle$}};
                         \end{tikzpicture}}]{$pdf-cover-image$}
$endif$
$endif$
%% -----
```

What it does is looking into the Notebook header and check the options of pdf-cover-image and report-title. If this two options exist and are not empty then it adds a pdf file given by the user and adds a title and subtitel which is defined by the user on the option report-title and report-subtitle.

The title is added as an image on top of the new imported pdf file. The title and subtitle position is given and should be changed according to user needs. If the user whichs to let this be defined inside the Notebook he can substitute the absolute position into a variable like (8.2,-4) > ($x$,$y$)



## The introduction page

```latex
%----------------------------------------------------------------------------------------
%	INCLUDE IQ GENERAL DESCRIPTION
%----------------------------------------------------------------------------------------
\begin{minipage}{0.35\linewidth} % [b] or [t] for alignment
\includegraphics[width=3.7cm]{images/iq.png}\\
\end{minipage}
%
\begin{minipage}{0.65\linewidth}
\LARGE\color{DarkPurple}\textbf{IQ Digital} 
\large{is a methodology developed by Math Marketing which measures the actual experience offered to users. As a diagnosis tool, it helps both customers and teams to identify potential areas for future development and improvement. Its goal is to optimize engagement and conversion through the combination of 6 distinct dimensions. Market reports as this one, apply this methodology only to publicly available information and provide only high-level diagnosis.}
\end{minipage}

\vspace{1cm}
```

```latex
%----------------------------------------------------------------------------------------
%	INCLUDE EVERY PILLAR DESCRIPTION
%----------------------------------------------------------------------------------------

\setlength{\columnsep}{1cm}
\setlength{\columnseprule}{1pt}
\def\columnseprulecolor{\color{Grey}}
\begin{multicols}{2}
\subsubsection{INTERACTION}
It measure the capacity available for new customer impressions, attraction and interaction.\\

\textbf{\large{Ads}}\\
Since it is not possible to evaluate the competition's digital advertising assertiveness, it looks into current available tools:
\setlist{nolistsep}
\begin{enumerate}[noitemsep]
  \item Uses Paid Ads 
  \item Has a social media strategy
  \item Uses an aggregator
  \item Uses an optimizer
  \item DMP with internal and external data
\end{enumerate}

```

## The back cover



## Defining a style



## Latex functions

http://texdoc.net/texmf-dist/doc/latex/tcolorbox/tcolorbox.pdf

```latex
%----------------------------------------------------------------------------------------
%	NEW COMMANDS
%-------------------------------------------------------------------------------------

\newcommand{\impactBox}[2]{
  \begin{tcolorbox}[width=\textwidth,
  fonttitle = \sffamily\bfseries\large, 
  colframe={mediumGreen},
  colback={lightGreen},
  title={#1},
  sharp corners]  
  \textsc{#2}
  \end{tcolorbox} 
}

\newcommand{\attentionBox}[1]{
  \begin{tcolorbox}[fonttitle = \sffamily\bfseries\large,
  bicolor,
  sidebyside,
  lefthand width=0.5cm,
  sharp corners,
  boxrule=.4pt,
  colback=yellow!30,
  colbacklower=yellow!20]
    \includegraphics[scale=5]{images/attention-sign.png}
  \tcblower
    \textsc{#1}%
  \end{tcolorbox}
}
```

## Final thoughts and next steps

--- 
Math Marketing <link> has helped companies from a variety of industries to implement Data Driven processes<link para texto de data driven marketing>. By mixing statistical proficiency, business knowledge and advance tools we help our customer answer though questions. Some of the largest brands share with us with their data challenges, and trust our data generated insights on everyday operational and strategic decisions.

If you want to learn about our projects and methodology reach us over the e-mail or contact any of our team managers directly on Linkedin<link>. We are always available to share our insights with you and listen to your experience.